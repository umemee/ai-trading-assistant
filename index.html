<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI 트레이딩 어시스턴트 V5.4 (실제 환경용)</title>

<!-- TailwindCSS, FontAwesome -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
  body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
  .section { display:none; padding:1rem; }
  .section.active { display:block; }
  .nav-btn.active { background:#2563eb; color:#fff; }
  .toast {
    position: fixed;
    top: 1rem; right: 1rem;
    background: #10b981;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.375rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .toast.show {
    opacity: 1;
  }
  .atom-card {
    background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .molecule-signal {
    background: linear-gradient(135deg, #ef4444, #f87171);
    color: white; padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem;
    font-weight: bold;
  }
</style>
</head>

<body>

<!-- 간단한 비밀번호 보호 모달 -->
<div id="login-modal" style="
  position: fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center; z-index:9999;">
  <div style="background:white; padding:2rem; border-radius:0.5rem; width:320px;">
    <h2 class="text-xl font-semibold mb-4">접근 인증</h2>
    <input id="password-input" type="password" placeholder="비밀번호 입력" style="width: 100%; padding:0.5rem; font-size:1rem; border:1px solid #ccc; border-radius:0.25rem;" />
    <button id="login-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">입장하기</button>
    <p class="text-sm mt-2 text-gray-500">이 사이트는 개인 용도로만 사용하세요.</p>
  </div>
</div>

<!-- 네비게이션 -->
<nav class="bg-gray-800 text-white p-4 flex space-x-4">
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-dashboard">대시보드</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-training">훈련 (LogicDiscoverer)</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-scan">예측 (SignalScanner)</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-growth">성장 (MetaLearner)</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-settings">설정</button>
</nav>

<!-- 대시보드 -->
<section id="section-dashboard" class="section active container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">🖥 시스템 대시보드</h1>
  <div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="atom-count">0</div>
      <div class="text-gray-500 mt-1">아톰 갯수</div>
    </div>
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="molecule-count">0</div>
      <div class="text-gray-500 mt-1">분자(전략) 갯수</div>
    </div>
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="signal-count">0</div>
      <div class="text-gray-500 mt-1">오늘 신호 수</div>
    </div>
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="growth-status">준비</div>
      <div class="text-gray-500 mt-1">성장 상태</div>
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow font-mono h-64 overflow-y-auto" id="activity-log"></div>
</section>

<!-- 훈련 (LogicDiscoverer) -->
<section id="section-training" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">🧠 AI 훈련</h1>
  <div class="bg-white p-6 rounded shadow mb-6">
    <div class="grid grid-cols-2 gap-4 mb-4">
      <input id="train-ticker" type="text" placeholder="종목 (예: AAPL)" class="border p-2 rounded" />
      <input id="train-date" type="date" class="border p-2 rounded" />
    </div>
    <textarea id="train-note" placeholder="핵심 통찰 입력..." class="border p-2 rounded w-full h-24"></textarea>
    <button id="btn-train" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mt-3">훈련 시작</button>
  </div>
  <div id="train-result" class="bg-white p-4 rounded shadow whitespace-pre-wrap hidden"></div>
  <button id="btn-train-approve" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-3 hidden">로직 DB에 추가 승인</button>
</section>

<!-- 예측 (SignalScanner) -->
<section id="section-scan" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">📡 신호 예측</h1>
  <div class="bg-white p-6 rounded shadow mb-6 flex gap-2">
    <input id="scan-ticker-input" maxlength="5" placeholder="감시 종목 추가 (티커)" class="flex-1 border p-2 rounded" />
    <button id="btn-add-ticker" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">추가</button>
  </div>

  <div id="watchlist" class="mb-6 flex flex-wrap gap-2"></div>

  <div class="flex gap-4 mb-4">
    <button id="btn-start-scan" class="bg-green-600 text-white px-6 py-2 rounded">스캐너 시작</button>
    <button id="btn-stop-scan" class="bg-red-600 text-white px-6 py-2 rounded" disabled>스캐너 정지</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="atom-card overflow-y-auto h-48" id="atom-log">아톰 탐지 로그...</div>
    <div class="molecule-signal overflow-y-auto h-48" id="molecule-log">분자 신호 로그...</div>
  </div>
</section>

<!-- 성장 (MetaLearner) -->
<section id="section-grow" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">🌱 성장 복기</h1>
  <select id="grow-ticker-select" class="border p-2 rounded mb-4 w-full"></select>
  <select id="grow-pred-select" class="border p-2 rounded mb-4 w-full"></select>
  <textarea id="grow-result" placeholder="복기 실적 입력..." class="border p-2 rounded w-full h-24"></textarea>
  <button id="btn-grow-analyze" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">복기 시작</button>
  <div id="grow-report" class="p-4 mt-4 bg-white rounded shadow whitespace-pre-wrap hidden"></div>
  <button id="btn-grow-approve" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-2 hidden">성장 반영 승인</button>
</section>

<!-- 설정 -->
<section id="section-set" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">⚙ API 설정</h1>
  <div class="grid grid-cols-1 gap-4 max-w-lg">
    <input id="inp-alpaca-key" placeholder="Alpaca API Key" class="border p-2 rounded" />
    <input id="inp-alpaca-secret" placeholder="Alpaca Secret Key" class="border p-2 rounded" />
    <input id="inp-gemini-key" placeholder="Google Gemini API Key" class="border p-2 rounded" />
    <input id="inp-sheet-id" placeholder="Google Sheets ID" class="border p-2 rounded" />
    <input id="inp-sheet-api-key" placeholder="Google Sheets API Key" class="border p-2 rounded" />
    <button id="btn-save-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">설정 저장</button>
  </div>
  <div id="set-status" class="mt-3 text-sm text-green-700"></div>
</section>

<script>
(() => {
  // 🔧 사용자 수정값: 반드시 실제 값으로 수정하세요
  const ACCESS_PASSWORD = 'trade2025_secure'; // 비밀번호
  // 상태 변수
  let config = {};
  let atoms = [], molecules = [], watchlist = [], predictions = [];
  let scanInterval = null;

  // HTML 요소 바로 가기
  const $ = id => document.getElementById(id);

  // 비밀번호 인증
  $('login-modal').style.display = 'flex';
  $('login-modal').querySelector('button').onclick = () => {
    const val = $('password-input').value.trim();
    if(val === ACCESS_PASSWORD){
      $('login-modal').style.display = 'none';
      initApp();
      sessionStorage.setItem('auth-ok','true');
    } else{
      alert('비밀번호가 올바르지 않습니다.');
      $('password-input').value = '';
    }
  };
  if(sessionStorage.getItem('auth-ok') === 'true'){
    $('login-modal').style.display = 'none';
    initApp();
  }

  // 섹션 전환
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = e => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      const idMap = {
        'nav-dashboard':'dash', 'nav-training':'train',
        'nav-scan':'scan', 'nav-growth':'grow', 'nav-settings':'set'
      };
      $(idMap[e.target.id]).classList.add('active');
    };
  });

  // 초기화
  async function initApp(){
    loadSettings();
    await loadLogicDB();
    updateDashboard();
    renderWatchlist();
    toast('시스템 초기화 완료', 'success');
  }

  // 토스트 알림
  function toast(msg, type='success'){
    let d = document.createElement('div');
    d.className = 'toast '+type;
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.classList.add('show'), 20);
    setTimeout(() => {
      d.classList.remove('show');
      setTimeout(() => d.remove(), 300);
    }, 3000);
  }

  // 설정 저장/로드 (세션스토리지)
  function saveSettings(){
    config.alpacaKey = $('inp-alpaca-key').value.trim();
    config.alpacaSecret = $('inp-alpaca-secret').value.trim();
    config.geminiKey = $('inp-gemini-key').value.trim();
    config.sheetId = $('inp-sheet-id').value.trim();
    config.sheetApiKey = $('inp-sheet-api-key').value.trim();
    sessionStorage.setItem('trade-config', JSON.stringify(config));
    $('set-status').textContent = '✅ 설정 저장 완료';
    toast('설정이 저장되었습니다');
  }
  function loadSettings(){
    let s = sessionStorage.getItem('trade-config');
    if(s) config = JSON.parse(s);
    $('inp-alpaca-key').value = config.alpacaKey || '';
    $('inp-alpaca-secret').value = config.alpacaSecret || '';
    $('inp-gemini-key').value = config.geminiKey || '';
    $('inp-sheet-id').value = config.sheetId || '';
    $('inp-sheet-api-key').value = config.sheetApiKey || '';
  }
  $('btn-save-settings').onclick = saveSettings;

  // 구글시트에서 아톰/분자 DB 불러오기
  async function loadLogicDB(){
    if(!config.sheetId || !config.sheetApiKey){
      toast('Sheets 정보 부족, 기본 아톰 사용','info');
      atoms = demoAtoms();
      molecules = demoMolecules();
      return;
    }
    try{
      // 아톰 로드
      let urlAtom = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/Atom_DB!A2:F?key=${config.sheetApiKey}`;
      let respAtom = await fetch(urlAtom);
      let jsonAtom = await respAtom.json();
      atoms = jsonAtom.values.map(r=>({id:r[0],name:r[1],description:r[2],category:r[4]}));
      // 분자 로드
      let urlMol = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/Molecule_DB!A2:F?key=${config.sheetApiKey}`;
      let respMol = await fetch(urlMol);
      let jsonMol = await respMol.json();
      molecules = jsonMol.values.map(r=>({
        id:r[0],name:r[1],category:r[2],requiredAtoms:r[3]?.split(',').map(s=>s.trim())||[],threshold:parseFloat(r[4])
      }));
      toast(`🔥 아톰 ${atoms.length}, 분자 ${molecules.length}개 로드완료`);
      updateDashboard();
    }catch(e){
      toast('Sheets 읽기 실패, 기본 아톰 사용','error');
      atoms = demoAtoms();
      molecules = demoMolecules();
      updateDashboard();
    }
  }
  function demoAtoms(){
    return [
      {id:"CTX-001",name:"촉매_A++등급",category:"Context"},
      {id:"STR-003",name:"1분_20EMA_지지",category:"Structural"},
      {id:"TRG-003",name:"거래량_폭발",category:"Trigger"}
    ];
  }
  function demoMolecules(){
    return [{
      id:"LOGIC-EXP-004",
      name:"장 초반 정배열 후 첫 눌림목",
      category:"진입",
      requiredAtoms:["CTX-001","STR-003","TRG-003"],
      threshold:80
    }]
  }

  // 대시보드 업데이트
  function updateDashboard(){
    $("atom-count").textContent = atoms.length;
    $("molecule-count").textContent = molecules.length;
    $("signal-count").textContent = 0; // 신호 카운터는 스캐너 작동시 갱신됨
    $("growth-status").textContent = '준비';
  }

  // 감시 종목 UI 렌더링
  function renderWatchlist(){
    const container = $('watchlist');
    container.innerHTML = '';
    watchlist.forEach(t => {
      const span = document.createElement('span');
      span.className = 'bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm mr-2 mb-2 inline-flex items-center';
      span.innerHTML = `${t} <button onclick="removeTicker('${t}')" class="ml-1 text-red-500 hover:text-red-700">×</button>`;
      container.appendChild(span);
    });
  }
  $('btn-add-ticker').onclick = () => {
    let val = $('scan-ticker-input').value.toUpperCase().trim();
    if(!val) return toast('티커 입력하세요','error');
    if(watchlist.includes(val)) return toast('이미 추가됨','error');
    if(watchlist.length >= 10) return toast('최대 10개 제한','error');
    watchlist.push(val);
    $('scan-ticker-input').value = '';
    renderWatchlist();
    log(`종목 추가: ${val}`);
    toast(`${val} 추가`,'success');
  };
  window.removeTicker = function(ticker){
    watchlist = watchlist.filter(it => it !== ticker);
    renderWatchlist();
    log(`종목 제거: ${ticker}`);
  };

  // 스캐너 작동 시뮬레이션
  let signalCount = 0;
  function fakeScan(){
    if(watchlist.length === 0) return;
    let t = watchlist[Math.floor(Math.random()*watchlist.length)];
    let price = (50 + Math.random()*200).toFixed(2);
    let vol = Math.floor(Math.random()*1000000);
    let atom = atoms[Math.floor(Math.random()*atoms.length)];
    let grade = ['A++','A+','B+','C','F'][Math.floor(Math.random()*5)];
    $('atom-log').innerHTML += `<div class="atom-card"><strong>${t}</strong> ${atom.id} (${atom.name}) (호재: ${grade}) $${price} Vol:${vol.toLocaleString()}</div>`;
    $('atom-log').scrollTop = $('atom-log').scrollHeight;
    log(`아톰 탐지: ${t} - ${atom.id} (호재등급: ${grade})`);

    if(Math.random() < 0.15 && grade!=='F'){
      signalCount++;
      $('signal-count').textContent = signalCount;
      const mol = molecules[Math.floor(Math.random()*molecules.length)];
      $('mol-log').innerHTML += `<div class="molecule-signal">${t} ${mol.id}: ${mol.name} 신호!</div>`;
      $('mol-log').scrollTop = $('mol-log').scrollHeight;
      log(`분자 신호: ${t} - ${mol.id}`);
    }
  }
  $('btn-start-scan').onclick = () => {
    if(watchlist.length === 0) return toast('종목이 없습니다!','error');
    $('btn-start-scan').disabled = true;
    $('btn-stop-scan').disabled = false;
    signalCount = 0; $('signal-count').textContent = '0';
    scanInterval = setInterval(fakeScan, 5000);
    log('✅ 스캐너 시작');
    toast('스캐너가 시작되었습니다.');
  };
  $('btn-stop-scan').onclick = () => {
    if(scanInterval) clearInterval(scanInterval);
    scanInterval = null;
    $('btn-start-scan').disabled = false;
    $('btn-stop-scan').disabled = true;
    log('⏹️ 스캐너 정지');
    toast('스캐너가 정지되었습니다.','info');
  };

  // 훈련 버튼 클릭 시 (Gemini API 호출 예시)
  $('btn-train').onclick = async () => {
    const ticker = $('train-ticker').value.trim();
    const date = $('train-date').value.trim();
    const insight = $('train-note').value.trim();

    if(!ticker || !date || !insight){
      toast('모든 입력란을 채워주세요', 'error');
      return;
    }
    if(!config.geminiKey){
      toast('Gemini API Key를 설정하세요', 'error');
      show('set');
      return;
    }
    const prompt = `당신은 전문 트레이딩 시스템 분석가입니다.\n\n
종목: ${ticker}\n날짜: ${date}\n통찰: ${insight}\n
새로운 아톰과 분자를 JSON 형식으로 제안해 주세요.`;

    try {
      $('train-result').classList.remove('hidden');
      $('train-json').textContent = '분석 중...';

      const res = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=' + config.geminiKey, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{parts:[{text: prompt}]}]
        })
      });
      if(!res.ok) throw new Error('Gemini API 에러: ' + res.status);
      const data = await res.json();
      if(data.candidates?.length > 0){
        $('train-json').textContent = data.candidates[0].content.parts[0].text;
        log('AI 훈련 완료');
      } else {
        $('train-json').textContent = 'AI 응답 없음';
      }
    } catch(e){
      $('train-json').textContent = e.toString();
      log('훈련 오류:' + e);
    }
  };

  // 로직 DB 추가 승인 (수동 - 실제 구글 시트 반영 기능은 백엔드로 추가 필요)
  $('btn-train-approve').onclick = () => {
    toast('DB 추가 승인 - 실제 저장은 백엔드가 필요합니다.', 'info');
    $('train-result').classList.add('hidden');
  };

  // 성장 복기 UI 업데이트, 실제 Gemini 호출은 동일 구조로 확장 가능
  $('grow-ticker-select').onchange = () => {
    const ticker = $('grow-ticker-select').value;
    const filtered = predictions.filter(p => p.ticker === ticker);
    const sel = $('grow-pred-select');
    sel.innerHTML = '<option>예측 선택</option>';
    filtered.forEach((p,i) => {
      sel.innerHTML += `<option value="${i}">${p.molecule} - 진입가 $${p.entryPrice.toFixed(2)}</option>`;
    });
  };
  $('btn-grow-analyze').onclick = async () => {
    if(!config.geminiKey){
      toast('Gemini API Key를 설정하세요', 'error');
      show('set');
      return;
    }
    const ticker = $('grow-ticker-select').value;
    const predIdx = $('grow-pred-select').value;
    const actual = $('grow-result').value.trim();
    if(!ticker || predIdx === '' || actual === ''){
      toast('티커, 예측, 실제 결과 모두 선택/입력하세요', 'error');
      return;
    }
    $('grow-report').classList.remove('hidden');
    $('grow-json').textContent = 'AI 분석 중...';

    const prediction = predictions.filter(p => p.ticker === ticker)[predIdx];
    const prompt = `당신은 AI 트레이딩 시스템 분석가입니다.\n예측 정보: ${JSON.stringify(prediction)}\n실제 결과: ${actual}\n분석 및 개선점 제시. JSON 응답 바랍니다.`;

    try{
      const res = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=' + config.geminiKey, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({contents:[{parts:[{text: prompt}]}]})
      });
      if(!res.ok) throw new Error('API 오류 ' + res.status);
      const json = await res.json();
      if(json.candidates?.length > 0){
        try{
          let data = JSON.parse(json.candidates[0].content.parts[0].text);
          $('grow-report').textContent = JSON.stringify(data, null, 2);
          log('AI 복기 분석 완료');
          toast('복기 분석 완료', 'success');
        } catch(e) {
          $('grow-report').textContent = json.candidates[0].content.parts[0].text;
        }
      }
    }catch(e){
      $('grow-report').textContent = e.toString();
      toast('복기 오류: ' + e.message, 'error');
    }
  };

  $('btn-grow-approve').onclick = () => {
    toast('성장 반영 승인 - 실제 DB 업데이트는 백엔드 필요', 'info');
    $('grow-report').classList.add('hidden');
    $('grow-result').value = '';
    $('grow-pred-select').innerHTML = '';
    $('grow-ticker-select').value = '';
    $('grow-pred-select').value = '';
  };

  // 로그 출력
  function log(msg){
    let logDiv = $('activity-log') || $('log');
    let p = document.createElement('p');
    p.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

})();
</script>

</body>
</html>
