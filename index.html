<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>AI íŠ¸ë ˆì´ë”© ì–´ì‹œìŠ¤í„´íŠ¸ V5.4 (ì‹¤ì œ í™˜ê²½ìš©)</title>

<!-- TailwindCSS, FontAwesome -->
<script src="https://cdn.tailwindcss.com"></script>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css"/>

<style>
  body { font-family: 'Inter', sans-serif; background:#f3f4f6; }
  .section { display:none; padding:1rem; }
  .section.active { display:block; }
  .nav-btn.active { background:#2563eb; color:#fff; }
  .toast {
    position: fixed;
    top: 1rem; right: 1rem;
    background: #10b981;
    color: white;
    padding: 0.75rem 1.25rem;
    border-radius: 0.375rem;
    box-shadow: 0 2px 6px rgba(0,0,0,0.15);
    z-index: 10000;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .toast.show {
    opacity: 1;
  }
  .atom-card {
    background: white; border-radius: 0.5rem; padding: 1rem; margin-bottom: 0.75rem;
    box-shadow: 0 1px 2px rgba(0,0,0,0.1);
  }
  .molecule-signal {
    background: linear-gradient(135deg, #ef4444, #f87171);
    color: white; padding: 1rem; margin-bottom: 0.75rem; border-radius: 0.5rem;
    font-weight: bold;
  }
</style>
</head>

<body>

<!-- ê°„ë‹¨í•œ ë¹„ë°€ë²ˆí˜¸ ë³´í˜¸ ëª¨ë‹¬ -->
<div id="login-modal" style="
  position: fixed; inset:0; background:rgba(0,0,0,0.7);
  display:flex; align-items:center; justify-content:center; z-index:9999;">
  <div style="background:white; padding:2rem; border-radius:0.5rem; width:320px;">
    <h2 class="text-xl font-semibold mb-4">ì ‘ê·¼ ì¸ì¦</h2>
    <input id="password-input" type="password" placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥" style="width: 100%; padding:0.5rem; font-size:1rem; border:1px solid #ccc; border-radius:0.25rem;" />
    <button id="login-btn" class="mt-4 w-full bg-blue-600 text-white py-2 rounded hover:bg-blue-700">ì…ì¥í•˜ê¸°</button>
    <p class="text-sm mt-2 text-gray-500">ì´ ì‚¬ì´íŠ¸ëŠ” ê°œì¸ ìš©ë„ë¡œë§Œ ì‚¬ìš©í•˜ì„¸ìš”.</p>
  </div>
</div>

<!-- ë„¤ë¹„ê²Œì´ì…˜ -->
<nav class="bg-gray-800 text-white p-4 flex space-x-4">
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-dashboard">ëŒ€ì‹œë³´ë“œ</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-training">í›ˆë ¨ (LogicDiscoverer)</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-scan">ì˜ˆì¸¡ (SignalScanner)</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-growth">ì„±ì¥ (MetaLearner)</button>
  <button class="nav-btn px-4 py-2 rounded hover:bg-gray-700" id="nav-settings">ì„¤ì •</button>
</nav>

<!-- ëŒ€ì‹œë³´ë“œ -->
<section id="section-dashboard" class="section active container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">ğŸ–¥ ì‹œìŠ¤í…œ ëŒ€ì‹œë³´ë“œ</h1>
  <div class="grid grid-cols-4 gap-4 mb-6">
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="atom-count">0</div>
      <div class="text-gray-500 mt-1">ì•„í†° ê°¯ìˆ˜</div>
    </div>
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="molecule-count">0</div>
      <div class="text-gray-500 mt-1">ë¶„ì(ì „ëµ) ê°¯ìˆ˜</div>
    </div>
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="signal-count">0</div>
      <div class="text-gray-500 mt-1">ì˜¤ëŠ˜ ì‹ í˜¸ ìˆ˜</div>
    </div>
    <div class="bg-white p-4 rounded shadow flex flex-col items-center">
      <div class="text-3xl font-extrabold" id="growth-status">ì¤€ë¹„</div>
      <div class="text-gray-500 mt-1">ì„±ì¥ ìƒíƒœ</div>
    </div>
  </div>

  <div class="bg-white p-4 rounded shadow font-mono h-64 overflow-y-auto" id="activity-log"></div>
</section>

<!-- í›ˆë ¨ (LogicDiscoverer) -->
<section id="section-training" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">ğŸ§  AI í›ˆë ¨</h1>
  <div class="bg-white p-6 rounded shadow mb-6">
    <div class="grid grid-cols-2 gap-4 mb-4">
      <input id="train-ticker" type="text" placeholder="ì¢…ëª© (ì˜ˆ: AAPL)" class="border p-2 rounded" />
      <input id="train-date" type="date" class="border p-2 rounded" />
    </div>
    <textarea id="train-note" placeholder="í•µì‹¬ í†µì°° ì…ë ¥..." class="border p-2 rounded w-full h-24"></textarea>
    <button id="btn-train" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded mt-3">í›ˆë ¨ ì‹œì‘</button>
  </div>
  <div id="train-result" class="bg-white p-4 rounded shadow whitespace-pre-wrap hidden"></div>
  <button id="btn-train-approve" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-3 hidden">ë¡œì§ DBì— ì¶”ê°€ ìŠ¹ì¸</button>
</section>

<!-- ì˜ˆì¸¡ (SignalScanner) -->
<section id="section-scan" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">ğŸ“¡ ì‹ í˜¸ ì˜ˆì¸¡</h1>
  <div class="bg-white p-6 rounded shadow mb-6 flex gap-2">
    <input id="scan-ticker-input" maxlength="5" placeholder="ê°ì‹œ ì¢…ëª© ì¶”ê°€ (í‹°ì»¤)" class="flex-1 border p-2 rounded" />
    <button id="btn-add-ticker" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">ì¶”ê°€</button>
  </div>

  <div id="watchlist" class="mb-6 flex flex-wrap gap-2"></div>

  <div class="flex gap-4 mb-4">
    <button id="btn-start-scan" class="bg-green-600 text-white px-6 py-2 rounded">ìŠ¤ìºë„ˆ ì‹œì‘</button>
    <button id="btn-stop-scan" class="bg-red-600 text-white px-6 py-2 rounded" disabled>ìŠ¤ìºë„ˆ ì •ì§€</button>
  </div>

  <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
    <div class="atom-card overflow-y-auto h-48" id="atom-log">ì•„í†° íƒì§€ ë¡œê·¸...</div>
    <div class="molecule-signal overflow-y-auto h-48" id="molecule-log">ë¶„ì ì‹ í˜¸ ë¡œê·¸...</div>
  </div>
</section>

<!-- ì„±ì¥ (MetaLearner) -->
<section id="section-grow" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">ğŸŒ± ì„±ì¥ ë³µê¸°</h1>
  <select id="grow-ticker-select" class="border p-2 rounded mb-4 w-full"></select>
  <select id="grow-pred-select" class="border p-2 rounded mb-4 w-full"></select>
  <textarea id="grow-result" placeholder="ë³µê¸° ì‹¤ì  ì…ë ¥..." class="border p-2 rounded w-full h-24"></textarea>
  <button id="btn-grow-analyze" class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded">ë³µê¸° ì‹œì‘</button>
  <div id="grow-report" class="p-4 mt-4 bg-white rounded shadow whitespace-pre-wrap hidden"></div>
  <button id="btn-grow-approve" class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded mt-2 hidden">ì„±ì¥ ë°˜ì˜ ìŠ¹ì¸</button>
</section>

<!-- ì„¤ì • -->
<section id="section-set" class="section container mx-auto max-w-4xl">
  <h1 class="text-2xl font-bold mb-6 mt-6">âš™ API ì„¤ì •</h1>
  <div class="grid grid-cols-1 gap-4 max-w-lg">
    <input id="inp-alpaca-key" placeholder="Alpaca API Key" class="border p-2 rounded" />
    <input id="inp-alpaca-secret" placeholder="Alpaca Secret Key" class="border p-2 rounded" />
    <input id="inp-gemini-key" placeholder="Google Gemini API Key" class="border p-2 rounded" />
    <input id="inp-sheet-id" placeholder="Google Sheets ID" class="border p-2 rounded" />
    <input id="inp-sheet-api-key" placeholder="Google Sheets API Key" class="border p-2 rounded" />
    <button id="btn-save-settings" class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded">ì„¤ì • ì €ì¥</button>
  </div>
  <div id="set-status" class="mt-3 text-sm text-green-700"></div>
</section>

<script>
(() => {
  // ğŸ”§ ì‚¬ìš©ì ìˆ˜ì •ê°’: ë°˜ë“œì‹œ ì‹¤ì œ ê°’ìœ¼ë¡œ ìˆ˜ì •í•˜ì„¸ìš”
  const ACCESS_PASSWORD = 'trade2025_secure'; // ë¹„ë°€ë²ˆí˜¸
  // ìƒíƒœ ë³€ìˆ˜
  let config = {};
  let atoms = [], molecules = [], watchlist = [], predictions = [];
  let scanInterval = null;

  // HTML ìš”ì†Œ ë°”ë¡œ ê°€ê¸°
  const $ = id => document.getElementById(id);

  // ë¹„ë°€ë²ˆí˜¸ ì¸ì¦
  $('login-modal').style.display = 'flex';
  $('login-modal').querySelector('button').onclick = () => {
    const val = $('password-input').value.trim();
    if(val === ACCESS_PASSWORD){
      $('login-modal').style.display = 'none';
      initApp();
      sessionStorage.setItem('auth-ok','true');
    } else{
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      $('password-input').value = '';
    }
  };
  if(sessionStorage.getItem('auth-ok') === 'true'){
    $('login-modal').style.display = 'none';
    initApp();
  }

  // ì„¹ì…˜ ì „í™˜
  document.querySelectorAll('.nav-btn').forEach(btn => {
    btn.onclick = e => {
      document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
      document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
      e.target.classList.add('active');
      const idMap = {
        'nav-dashboard':'dash', 'nav-training':'train',
        'nav-scan':'scan', 'nav-growth':'grow', 'nav-settings':'set'
      };
      $(idMap[e.target.id]).classList.add('active');
    };
  });

  // ì´ˆê¸°í™”
  async function initApp(){
    loadSettings();
    await loadLogicDB();
    updateDashboard();
    renderWatchlist();
    toast('ì‹œìŠ¤í…œ ì´ˆê¸°í™” ì™„ë£Œ', 'success');
  }

  // í† ìŠ¤íŠ¸ ì•Œë¦¼
  function toast(msg, type='success'){
    let d = document.createElement('div');
    d.className = 'toast '+type;
    d.textContent = msg;
    document.body.appendChild(d);
    setTimeout(() => d.classList.add('show'), 20);
    setTimeout(() => {
      d.classList.remove('show');
      setTimeout(() => d.remove(), 300);
    }, 3000);
  }

  // ì„¤ì • ì €ì¥/ë¡œë“œ (ì„¸ì…˜ìŠ¤í† ë¦¬ì§€)
  function saveSettings(){
    config.alpacaKey = $('inp-alpaca-key').value.trim();
    config.alpacaSecret = $('inp-alpaca-secret').value.trim();
    config.geminiKey = $('inp-gemini-key').value.trim();
    config.sheetId = $('inp-sheet-id').value.trim();
    config.sheetApiKey = $('inp-sheet-api-key').value.trim();
    sessionStorage.setItem('trade-config', JSON.stringify(config));
    $('set-status').textContent = 'âœ… ì„¤ì • ì €ì¥ ì™„ë£Œ';
    toast('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤');
  }
  function loadSettings(){
    let s = sessionStorage.getItem('trade-config');
    if(s) config = JSON.parse(s);
    $('inp-alpaca-key').value = config.alpacaKey || '';
    $('inp-alpaca-secret').value = config.alpacaSecret || '';
    $('inp-gemini-key').value = config.geminiKey || '';
    $('inp-sheet-id').value = config.sheetId || '';
    $('inp-sheet-api-key').value = config.sheetApiKey || '';
  }
  $('btn-save-settings').onclick = saveSettings;

  // êµ¬ê¸€ì‹œíŠ¸ì—ì„œ ì•„í†°/ë¶„ì DB ë¶ˆëŸ¬ì˜¤ê¸°
  async function loadLogicDB(){
    if(!config.sheetId || !config.sheetApiKey){
      toast('Sheets ì •ë³´ ë¶€ì¡±, ê¸°ë³¸ ì•„í†° ì‚¬ìš©','info');
      atoms = demoAtoms();
      molecules = demoMolecules();
      return;
    }
    try{
      // ì•„í†° ë¡œë“œ
      let urlAtom = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/Atom_DB!A2:F?key=${config.sheetApiKey}`;
      let respAtom = await fetch(urlAtom);
      let jsonAtom = await respAtom.json();
      atoms = jsonAtom.values.map(r=>({id:r[0],name:r[1],description:r[2],category:r[4]}));
      // ë¶„ì ë¡œë“œ
      let urlMol = `https://sheets.googleapis.com/v4/spreadsheets/${config.sheetId}/values/Molecule_DB!A2:F?key=${config.sheetApiKey}`;
      let respMol = await fetch(urlMol);
      let jsonMol = await respMol.json();
      molecules = jsonMol.values.map(r=>({
        id:r[0],name:r[1],category:r[2],requiredAtoms:r[3]?.split(',').map(s=>s.trim())||[],threshold:parseFloat(r[4])
      }));
      toast(`ğŸ”¥ ì•„í†° ${atoms.length}, ë¶„ì ${molecules.length}ê°œ ë¡œë“œì™„ë£Œ`);
      updateDashboard();
    }catch(e){
      toast('Sheets ì½ê¸° ì‹¤íŒ¨, ê¸°ë³¸ ì•„í†° ì‚¬ìš©','error');
      atoms = demoAtoms();
      molecules = demoMolecules();
      updateDashboard();
    }
  }
  function demoAtoms(){
    return [
      {id:"CTX-001",name:"ì´‰ë§¤_A++ë“±ê¸‰",category:"Context"},
      {id:"STR-003",name:"1ë¶„_20EMA_ì§€ì§€",category:"Structural"},
      {id:"TRG-003",name:"ê±°ë˜ëŸ‰_í­ë°œ",category:"Trigger"}
    ];
  }
  function demoMolecules(){
    return [{
      id:"LOGIC-EXP-004",
      name:"ì¥ ì´ˆë°˜ ì •ë°°ì—´ í›„ ì²« ëˆŒë¦¼ëª©",
      category:"ì§„ì…",
      requiredAtoms:["CTX-001","STR-003","TRG-003"],
      threshold:80
    }]
  }

  // ëŒ€ì‹œë³´ë“œ ì—…ë°ì´íŠ¸
  function updateDashboard(){
    $("atom-count").textContent = atoms.length;
    $("molecule-count").textContent = molecules.length;
    $("signal-count").textContent = 0; // ì‹ í˜¸ ì¹´ìš´í„°ëŠ” ìŠ¤ìºë„ˆ ì‘ë™ì‹œ ê°±ì‹ ë¨
    $("growth-status").textContent = 'ì¤€ë¹„';
  }

  // ê°ì‹œ ì¢…ëª© UI ë Œë”ë§
  function renderWatchlist(){
    const container = $('watchlist');
    container.innerHTML = '';
    watchlist.forEach(t => {
      const span = document.createElement('span');
      span.className = 'bg-blue-100 text-blue-800 rounded-full px-3 py-1 text-sm mr-2 mb-2 inline-flex items-center';
      span.innerHTML = `${t} <button onclick="removeTicker('${t}')" class="ml-1 text-red-500 hover:text-red-700">Ã—</button>`;
      container.appendChild(span);
    });
  }
  $('btn-add-ticker').onclick = () => {
    let val = $('scan-ticker-input').value.toUpperCase().trim();
    if(!val) return toast('í‹°ì»¤ ì…ë ¥í•˜ì„¸ìš”','error');
    if(watchlist.includes(val)) return toast('ì´ë¯¸ ì¶”ê°€ë¨','error');
    if(watchlist.length >= 10) return toast('ìµœëŒ€ 10ê°œ ì œí•œ','error');
    watchlist.push(val);
    $('scan-ticker-input').value = '';
    renderWatchlist();
    log(`ì¢…ëª© ì¶”ê°€: ${val}`);
    toast(`${val} ì¶”ê°€`,'success');
  };
  window.removeTicker = function(ticker){
    watchlist = watchlist.filter(it => it !== ticker);
    renderWatchlist();
    log(`ì¢…ëª© ì œê±°: ${ticker}`);
  };

  // ìŠ¤ìºë„ˆ ì‘ë™ ì‹œë®¬ë ˆì´ì…˜
  let signalCount = 0;
  function fakeScan(){
    if(watchlist.length === 0) return;
    let t = watchlist[Math.floor(Math.random()*watchlist.length)];
    let price = (50 + Math.random()*200).toFixed(2);
    let vol = Math.floor(Math.random()*1000000);
    let atom = atoms[Math.floor(Math.random()*atoms.length)];
    let grade = ['A++','A+','B+','C','F'][Math.floor(Math.random()*5)];
    $('atom-log').innerHTML += `<div class="atom-card"><strong>${t}</strong> ${atom.id} (${atom.name}) (í˜¸ì¬: ${grade}) $${price} Vol:${vol.toLocaleString()}</div>`;
    $('atom-log').scrollTop = $('atom-log').scrollHeight;
    log(`ì•„í†° íƒì§€: ${t} - ${atom.id} (í˜¸ì¬ë“±ê¸‰: ${grade})`);

    if(Math.random() < 0.15 && grade!=='F'){
      signalCount++;
      $('signal-count').textContent = signalCount;
      const mol = molecules[Math.floor(Math.random()*molecules.length)];
      $('mol-log').innerHTML += `<div class="molecule-signal">${t} ${mol.id}: ${mol.name} ì‹ í˜¸!</div>`;
      $('mol-log').scrollTop = $('mol-log').scrollHeight;
      log(`ë¶„ì ì‹ í˜¸: ${t} - ${mol.id}`);
    }
  }
  $('btn-start-scan').onclick = () => {
    if(watchlist.length === 0) return toast('ì¢…ëª©ì´ ì—†ìŠµë‹ˆë‹¤!','error');
    $('btn-start-scan').disabled = true;
    $('btn-stop-scan').disabled = false;
    signalCount = 0; $('signal-count').textContent = '0';
    scanInterval = setInterval(fakeScan, 5000);
    log('âœ… ìŠ¤ìºë„ˆ ì‹œì‘');
    toast('ìŠ¤ìºë„ˆê°€ ì‹œì‘ë˜ì—ˆìŠµë‹ˆë‹¤.');
  };
  $('btn-stop-scan').onclick = () => {
    if(scanInterval) clearInterval(scanInterval);
    scanInterval = null;
    $('btn-start-scan').disabled = false;
    $('btn-stop-scan').disabled = true;
    log('â¹ï¸ ìŠ¤ìºë„ˆ ì •ì§€');
    toast('ìŠ¤ìºë„ˆê°€ ì •ì§€ë˜ì—ˆìŠµë‹ˆë‹¤.','info');
  };

  // í›ˆë ¨ ë²„íŠ¼ í´ë¦­ ì‹œ (Gemini API í˜¸ì¶œ ì˜ˆì‹œ)
  $('btn-train').onclick = async () => {
    const ticker = $('train-ticker').value.trim();
    const date = $('train-date').value.trim();
    const insight = $('train-note').value.trim();

    if(!ticker || !date || !insight){
      toast('ëª¨ë“  ì…ë ¥ë€ì„ ì±„ì›Œì£¼ì„¸ìš”', 'error');
      return;
    }
    if(!config.geminiKey){
      toast('Gemini API Keyë¥¼ ì„¤ì •í•˜ì„¸ìš”', 'error');
      show('set');
      return;
    }
    const prompt = `ë‹¹ì‹ ì€ ì „ë¬¸ íŠ¸ë ˆì´ë”© ì‹œìŠ¤í…œ ë¶„ì„ê°€ì…ë‹ˆë‹¤.\n\n
ì¢…ëª©: ${ticker}\në‚ ì§œ: ${date}\ní†µì°°: ${insight}\n
ìƒˆë¡œìš´ ì•„í†°ê³¼ ë¶„ìë¥¼ JSON í˜•ì‹ìœ¼ë¡œ ì œì•ˆí•´ ì£¼ì„¸ìš”.`;

    try {
      $('train-result').classList.remove('hidden');
      $('train-json').textContent = 'ë¶„ì„ ì¤‘...';

      const res = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=' + config.geminiKey, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          contents: [{parts:[{text: prompt}]}]
        })
      });
      if(!res.ok) throw new Error('Gemini API ì—ëŸ¬: ' + res.status);
      const data = await res.json();
      if(data.candidates?.length > 0){
        $('train-json').textContent = data.candidates[0].content.parts[0].text;
        log('AI í›ˆë ¨ ì™„ë£Œ');
      } else {
        $('train-json').textContent = 'AI ì‘ë‹µ ì—†ìŒ';
      }
    } catch(e){
      $('train-json').textContent = e.toString();
      log('í›ˆë ¨ ì˜¤ë¥˜:' + e);
    }
  };

  // ë¡œì§ DB ì¶”ê°€ ìŠ¹ì¸ (ìˆ˜ë™ - ì‹¤ì œ êµ¬ê¸€ ì‹œíŠ¸ ë°˜ì˜ ê¸°ëŠ¥ì€ ë°±ì—”ë“œë¡œ ì¶”ê°€ í•„ìš”)
  $('btn-train-approve').onclick = () => {
    toast('DB ì¶”ê°€ ìŠ¹ì¸ - ì‹¤ì œ ì €ì¥ì€ ë°±ì—”ë“œê°€ í•„ìš”í•©ë‹ˆë‹¤.', 'info');
    $('train-result').classList.add('hidden');
  };

  // ì„±ì¥ ë³µê¸° UI ì—…ë°ì´íŠ¸, ì‹¤ì œ Gemini í˜¸ì¶œì€ ë™ì¼ êµ¬ì¡°ë¡œ í™•ì¥ ê°€ëŠ¥
  $('grow-ticker-select').onchange = () => {
    const ticker = $('grow-ticker-select').value;
    const filtered = predictions.filter(p => p.ticker === ticker);
    const sel = $('grow-pred-select');
    sel.innerHTML = '<option>ì˜ˆì¸¡ ì„ íƒ</option>';
    filtered.forEach((p,i) => {
      sel.innerHTML += `<option value="${i}">${p.molecule} - ì§„ì…ê°€ $${p.entryPrice.toFixed(2)}</option>`;
    });
  };
  $('btn-grow-analyze').onclick = async () => {
    if(!config.geminiKey){
      toast('Gemini API Keyë¥¼ ì„¤ì •í•˜ì„¸ìš”', 'error');
      show('set');
      return;
    }
    const ticker = $('grow-ticker-select').value;
    const predIdx = $('grow-pred-select').value;
    const actual = $('grow-result').value.trim();
    if(!ticker || predIdx === '' || actual === ''){
      toast('í‹°ì»¤, ì˜ˆì¸¡, ì‹¤ì œ ê²°ê³¼ ëª¨ë‘ ì„ íƒ/ì…ë ¥í•˜ì„¸ìš”', 'error');
      return;
    }
    $('grow-report').classList.remove('hidden');
    $('grow-json').textContent = 'AI ë¶„ì„ ì¤‘...';

    const prediction = predictions.filter(p => p.ticker === ticker)[predIdx];
    const prompt = `ë‹¹ì‹ ì€ AI íŠ¸ë ˆì´ë”© ì‹œìŠ¤í…œ ë¶„ì„ê°€ì…ë‹ˆë‹¤.\nì˜ˆì¸¡ ì •ë³´: ${JSON.stringify(prediction)}\nì‹¤ì œ ê²°ê³¼: ${actual}\në¶„ì„ ë° ê°œì„ ì  ì œì‹œ. JSON ì‘ë‹µ ë°”ëë‹ˆë‹¤.`;

    try{
      const res = await fetch('https://generativelanguage.googleapis.com/v1/models/gemini-pro:generateContent?key=' + config.geminiKey, {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({contents:[{parts:[{text: prompt}]}]})
      });
      if(!res.ok) throw new Error('API ì˜¤ë¥˜ ' + res.status);
      const json = await res.json();
      if(json.candidates?.length > 0){
        try{
          let data = JSON.parse(json.candidates[0].content.parts[0].text);
          $('grow-report').textContent = JSON.stringify(data, null, 2);
          log('AI ë³µê¸° ë¶„ì„ ì™„ë£Œ');
          toast('ë³µê¸° ë¶„ì„ ì™„ë£Œ', 'success');
        } catch(e) {
          $('grow-report').textContent = json.candidates[0].content.parts[0].text;
        }
      }
    }catch(e){
      $('grow-report').textContent = e.toString();
      toast('ë³µê¸° ì˜¤ë¥˜: ' + e.message, 'error');
    }
  };

  $('btn-grow-approve').onclick = () => {
    toast('ì„±ì¥ ë°˜ì˜ ìŠ¹ì¸ - ì‹¤ì œ DB ì—…ë°ì´íŠ¸ëŠ” ë°±ì—”ë“œ í•„ìš”', 'info');
    $('grow-report').classList.add('hidden');
    $('grow-result').value = '';
    $('grow-pred-select').innerHTML = '';
    $('grow-ticker-select').value = '';
    $('grow-pred-select').value = '';
  };

  // ë¡œê·¸ ì¶œë ¥
  function log(msg){
    let logDiv = $('activity-log') || $('log');
    let p = document.createElement('p');
    p.textContent = '[' + new Date().toLocaleTimeString() + '] ' + msg;
    logDiv.appendChild(p);
    logDiv.scrollTop = logDiv.scrollHeight;
  }

})();
</script>

</body>
</html>
